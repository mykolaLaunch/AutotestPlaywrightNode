# План построения системы автотестирования (Playwright + TypeScript) для Windows 10

## 1) Цели и приоритеты
- Основной фокус: тестирование API и проверка состояния БД.
- Вторичный фокус: минимальный E2E/UI smoke (по необходимости).
- Проверка качества текстовых ответов/контента через LLM (OpenAI API).

## 2) Базовый стек и архитектура
- Язык/рантайм: Node.js LTS (рекомендуется 20.x), TypeScript.
- Тест-раннер: Playwright Test.
- HTTP-клиент: встроенный `request` контекст Playwright (`APIRequestContext`).
- Работа с БД:
    - PostgreSQL: `pg`
    - MS SQL Server: `mssql`
    - MySQL: `mysql2`
      (выбор конкретного драйвера по фактической БД).
- Отчетность: Playwright HTML report + Allure (опционально).
- Конфигурация: `.env` + профили окружений (`dev`, `qa`, `stage`).

## 3) Структура проекта
Рекомендуемая структура:
- `tests/api/` — API тесты по доменам (`auth`, `orders`, `users` и т.д.)
- `tests/db/` — DB-проверки и интеграционные сценарии
- `tests/contracts/` — контрактные/схемные проверки
- `fixtures/` — test fixtures (токены, клиенты API, db connections)
- `helpers/` — утилиты (генераторы данных, ретраи, логирование)
- `llm/` — интеграция с OpenAI и prompt-шаблоны
- `schemas/` — JSON schema для валидации ответов
- `data/` — тестовые данные/seed templates

## 4) Конфиги и секреты
- Секреты держать только в переменных окружения:
    - `OPENAI_API_KEY`
    - `API_BASE_URL`
    - `DB_HOST`, `DB_PORT`, `DB_USER`, `DB_PASSWORD`, `DB_NAME`
- В git хранить только `.env.example` без реальных ключей.
- Для Windows 10:
    - использовать PowerShell-compatible скрипты;
    - единый запуск через `npm scripts`.

## 5) Подход к API-тестам (приоритет №1)
- Проверки на уровне:
    1. HTTP статус/заголовки/время ответа
    2. JSON schema / обязательные поля
    3. Бизнес-правила (значения, сортировка, фильтры)
    4. Идемпотентность и негативные сценарии
- Категоризация:
    - `@smoke` — быстрый прогон критичных эндпоинтов
    - `@regression` — полный охват
    - `@negative` — ошибки и edge cases
- Обязательно реализовать correlation-id/logging для диагностики.

## 6) Подход к DB-проверкам (приоритет №2)
- Стратегия «API -> DB validation»:
    - после POST/PUT/DELETE проверять, что данные корректно записаны/обновлены/удалены в БД.
- Практики:
    - отдельный read-only пользователь БД для проверок (где возможно);
    - транзакции или гарантированная очистка test data;
    - детерминированные тестовые данные (seed/fixtures).
- Исключить флаки:
    - polling с timeout для eventually consistent систем.

## 7) Интеграция LLM (OpenAI) для валидаций
Использовать LLM как дополнительный слой проверок, не заменяя строгие ассерты.

### Где применять
- Проверка «качества» текстовых полей (summary, description, reason).
- Семантическая валидация: «ответ соответствует заданной политике/правилам».
- Классификация ответов API по критериям (например, тональность, полнота, соответствие шаблону).

### Как применять безопасно
- Детерминизировать вызовы:
    - низкая `temperature`;
    - фиксированный prompt-шаблон;
    - строгий JSON-ответ от модели.
- В тестах проверять не «сырую строку», а структурированный результат LLM (`pass/fail`, `reasons[]`, `score`).
- Добавить fallback:
    - если OpenAI недоступен, тест помечается `skipped`/`soft-fail` по отдельному тэгу `@llm`.
- Ограничить budget/latency:
    - кэшировать повторяющиеся проверки;
    - запуск `@llm` в nightly/regression, а не в каждом smoke.

## 8) Стратегия запуска в CI/CD
- Этапы пайплайна:
    1. `lint + typecheck`
    2. `smoke` API
    3. `regression` API + DB
    4. `@llm` (отдельный job)
- Артефакты:
    - HTML/Allure отчет
    - логи запросов/ответов (с маскированием секретов)
    - SQL-check logs
- Для Windows-агентов: проверить наличие браузеров Playwright, даже если UI почти не используется.

## 9) Набор минимальных DoD (Definition of Done)
- Поднят каркас проекта на TypeScript + Playwright.
- Есть минимум 10 критичных API тестов.
- Есть минимум 5 API->DB интеграционных тестов.
- Есть как минимум 2 LLM-валидации под тэгом `@llm`.
- Настроены отчеты и запуск из CI.
- Документация по локальному запуску на Windows 10.

## 10) Поэтапный roadmap (рекомендуется)
### Этап 1 (1 неделя): Foundation
- Инициализация проекта, tsconfig, playwright config, env-конфиги.
- Базовые фикстуры API и БД.
- 3-5 smoke API тестов.

### Этап 2 (1-2 недели): API + DB core
- Расширение покрытия по приоритетным эндпоинтам.
- DB-валидации для create/update/delete.
- Стабилизация данных и cleanup.

### Этап 3 (1 неделя): LLM слой
- OpenAI клиент + prompt templates.
- 1-2 критичных сценария с `@llm`.
- Режим graceful degradation при сбое внешнего API.

### Этап 4 (постоянно): Надежность и масштабирование
- Уменьшение flaky, оптимизация времени прогона, параллелизация.
- Метрики качества тестов (pass rate, mean duration, flaky rate).
- Расширение regression пакета.

## 11) Риски и меры
- Риск: нестабильность тестовых данных -> Решение: controlled fixtures + cleanup policy.
- Риск: зависимость от OpenAI latency/outage -> Решение: отдельный `@llm` job + fallback.
- Риск: дрейф API контрактов -> Решение: schema/contracts tests + versioning.

## 12) Что нужно от вас для старта
- Список критичных API (топ-10).
- Тип БД и доступ к тестовому стенду.
- Правила бизнес-валидации (что считать «корректным ответом»).
- Лимиты по времени прогона и частоте запусков.
- Политика использования OpenAI (лимиты, допустимость внешней передачи данных).